version: '3.8'

services:
  # ============================================
  # FastAPI Backend - Productos y Ofertas
  # ============================================
  productos-api:
    build:
      context: ./PharmaVida-Productos
      dockerfile: Dockerfile
    image: pharmavida_productos:latest
    container_name: pharmavida_productos
    env_file:
      - .env
    ports:
      - "8000:8000"
    restart: unless-stopped
    volumes:
      - ./PharmaVida-Productos:/app
    environment:
      - PYTHONPATH=/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/echo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Spring Boot Backend - Usuarios y Compras
  # ============================================
  usuarios-api:
    build:
      context: ./PharmaVida-Usuarios
      dockerfile: Dockerfile
    image: pharmavida_usuarios:latest
    container_name: pharmavida_usuarios
    env_file:
      - .env
    ports:
      - "8080:8080"
    restart: unless-stopped
    environment:
      - JAVA_OPTS=-Xmx512m -Xms256m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # Node.js/Express Backend - Recetas y MÃ©dicos
  # ============================================
  recetas-api:
    build:
      context: ./PharmaVida-Recetas
      dockerfile: Dockerfile
    image: pharmavida_recetas:latest
    container_name: pharmavida_recetas
    env_file:
      - .env
    ports:
      - "3000:3000"
    restart: unless-stopped
    volumes:
      - ~/.aws:/home/nodejs/.aws:ro
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/echo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s