version: '3.8'

networks:
  pharmavida-network:
    driver: bridge

services:
  # ============================================
  # FastAPI Backend - Productos y Ofertas
  # ============================================
  productos-api:
    build:
      context: ./PharmaVida-Productos
      dockerfile: Dockerfile
    image: pharmavida_productos:latest
    container_name: pharmavida_productos
    env_file:
      - .env
    ports:
      - "8000:8000"
    restart: unless-stopped
    volumes:
      - ./PharmaVida-Productos:/app
    environment:
      - PYTHONPATH=/app
    networks:
      - pharmavida-network

  # ============================================
  # Spring Boot Backend - Usuarios y Compras
  # ============================================
  usuarios-api:
    build:
      context: ./PharmaVida-Usuarios
      dockerfile: Dockerfile
    image: pharmavida_usuarios:latest
    container_name: pharmavida_usuarios
    env_file:
      - .env
    ports:
      - "8080:8080"
    restart: unless-stopped
    environment:
      - JAVA_OPTS=-Xmx512m -Xms256m
    networks:
      - pharmavida-network

  # ============================================
  # Node.js/Express Backend - Recetas y Médicos
  # ============================================
  recetas-api:
    build:
      context: ./PharmaVida-Recetas
      dockerfile: Dockerfile
    image: pharmavida_recetas:latest
    container_name: pharmavida_recetas
    env_file:
      - .env
    ports:
      - "3000:3000"
    restart: unless-stopped
    volumes:
      - ~/.aws:/home/nodejs/.aws:ro
    environment:
      - NODE_ENV=production
    networks:
      - pharmavida-network

  # ============================================
  # Flask Backend - Analítica y Data Processing
  # ============================================
  analitica-api:
    build:
      context: ./PharmaVida-Analitica-v3
      dockerfile: Dockerfile
    image: pharmavida_analitica:latest
    container_name: pharmavida_analitica
    env_file:
      - ./.env
    ports:
      - "5000:5000"
    restart: unless-stopped
    volumes:
      - ./PharmaVida-Analitica-v3:/app
      - ~/.aws:/root/.aws:ro
    environment:
      - PYTHONPATH=/app
      - INGESTA_BASE_URL=${INGESTA_BASE_URL}
      - ATHENA_OUTPUT_LOCATION=${ATHENA_OUTPUT_LOCATION}
      - ATHENA_DATABASE=${ATHENA_DATABASE}
    networks:
      - pharmavida-network

  # ============================================
  # Django Backend - Orquestador de Microservicios
  # ============================================
  orquestador-api:
    build:
      context: ./PharmaVida-Orquestador
      dockerfile: Dockerfile
    image: pharmavida_orquestador:latest
    container_name: pharmavida_orquestador
    env_file:
      - .env
    ports:
      - "8888:8888"
    restart: unless-stopped
    volumes:
      - ./PharmaVida-Orquestador:/app
    environment:
      - PYTHONPATH=/app
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=${DEBUG}
      - URL_USUARIOS_COMPRAS=${URL_USUARIOS_COMPRAS}
      - URL_PRODUCTOS_OFERTAS=${URL_PRODUCTOS_OFERTAS}
      - URL_RECETAS_MEDICOS=${URL_RECETAS_MEDICOS}
      - URL_ANALITICA=${URL_ANALITICA}
    networks:
      - pharmavida-network
    depends_on:
      - productos-api
      - usuarios-api
      - recetas-api
      - analitica-api